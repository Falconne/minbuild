<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
    <!-- Test with:
         msbuild <sln> /p:Configuration=Release /p:Platform="Any CPU" /verbosity:m /t:rebuild /p:CustomBeforeMicrosoftCommonTargets="C:\git\minbuild\CacheArtifacts\bin\Debug\minbuild.targets" /p:ForceImportAfterCppTargets="C:\git\minbuild\CacheArtifacts\bin\Debug\minbuild.targes" /filelogger /flp:verbosity=m-->
    <UsingTask TaskName="MinBuild.CacheArtifacts"
               AssemblyFile="$(MSBuildThisFileDirectory)CacheArtifacts.dll" />

    <UsingTask TaskName="MinBuild.CheckCompileCache"
               AssemblyFile="$(MSBuildThisFileDirectory)CacheArtifacts.dll" />

    <PropertyGroup>
        <TargetsTriggeredByCompilation>
            $(TargetsTriggeredByCompilation);
            CacheArtifactsAfterCompile
        </TargetsTriggeredByCompilation>
    </PropertyGroup>

    <PropertyGroup>
        <CoreCompileDependsOn>
            $(CoreCompileDependsOn);
            CheckCompileCacheBeforeCompile
        </CoreCompileDependsOn>
    </PropertyGroup>

    <PropertyGroup>
        <InputFiles>
            $(MSBuildAllProjects);
            @(Compile);
            @(_CoreCompileResourceInputs);
            $(ApplicationIcon);
            $(AssemblyOriginatorKeyFile);
            @(ReferencePath);
            @(CompiledLicenseFile);
            @(LinkResource);
            @(EmbeddedDocumentation);
            $(Win32Resource);
            $(Win32Manifest);
            @(CustomAdditionalCompileInputs)
        </InputFiles>

        <OutputFiles>
            @(DocFileItem);
            @(IntermediateAssembly);
            @(_DebugSymbolsIntermediatePath);
            $(NonExistentFile);
            @(CustomAdditionalCompileOutputs)
        </OutputFiles>

        <BranchVersion Condition=" '$(BranchVersion)' == '' ">0</BranchVersion>
        <CacheRoot Condition=" '$(CacheRoot)' == '' ">c:\temp\minbuild</CacheRoot>
        <ShowRecompileReason Condition=" '$(ShowRecompileReason)' == '' ">false</ShowRecompileReason>
        <ShowContentHashes Condition=" '$(ShowContentHashes)' == '' ">true</ShowContentHashes>
    </PropertyGroup>

    <Target Name="CheckCompileCacheBeforeCompile"
        Inputs="$(InputFiles)"
        Outputs="$(OutputFiles)">

        <CheckCompileCache
            BranchVersion="$(BranchVersion)"
            CacheRoot="$(CacheRoot)"
            ShowRecompileReason="$(ShowRecompileReason)"
            ShowContentHashes="$(ShowContentHashes)"
            Inputs="$(InputFiles)"
            Outputs="$(OutputFiles)"
            BuildConfig="$(ConfigurationName)|$(PlatformName)"
            ProjectName="$(ProjectName)">
            
            <Output TaskParameter="InputHash" PropertyName="InputHash"/>
        </CheckCompileCache>

    </Target>

    <Target Name="CacheArtifactsAfterCompile">
        <CacheArtifacts
            BranchVersion="$(BranchVersion)"
            CacheRoot="$(CacheRoot)"
            InputHash="$(InputHash)"
            Outputs="$(OutputFiles)" 
            ProjectName="$(ProjectName)" />
    </Target>

    <Target Name="CheckCompileCacheBeforeCompileCPP" BeforeTargets="Build">
        <Message Text="*****Before Build: @(CLCompile)" Importance="high" />
        <Message Text="*****After TLogLocation: $(TLogLocation)" Importance="high" />
    </Target>

    <Target Name="CacheArtifactsCPP" AfterTargets="Build">
        <Message Text="*****Before Build: @(CLCompile)" Importance="high" />
        <Message Text="*****After TLogLocation: $(TLogLocation)" Importance="high" />
    </Target>
</Project>
