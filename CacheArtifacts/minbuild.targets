<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
    <!-- Test with:
         msbuild <sln> /p:Configuration=Release /p:Platform="Any CPU" /verbosity:m /t:rebuild /p:CustomBeforeMicrosoftCommonTargets="C:\git\minbuild\CacheArtifacts\bin\Debug\minbuild.targets" /filelogger /flp:verbosity=m-->
    <UsingTask TaskName="MinBuild.CacheArtifacts"
               AssemblyFile="$(MSBuildThisFileDirectory)CacheArtifacts.dll" />

    <UsingTask TaskName="MinBuild.CheckCompileCache"
               AssemblyFile="$(MSBuildThisFileDirectory)CacheArtifacts.dll" />

    <PropertyGroup>
        <TargetsTriggeredByCompilation>
            $(TargetsTriggeredByCompilation);
            CacheArtifactsAfterCompile
        </TargetsTriggeredByCompilation>
    </PropertyGroup>

    <PropertyGroup>
        <CoreCompileDependsOn>
            $(CoreCompileDependsOn);
            CheckCompileCacheBeforeCompile
        </CoreCompileDependsOn>
    </PropertyGroup>

    <PropertyGroup>
        <InputFiles>
            $(MSBuildAllProjects);
            @(Compile);
            @(_CoreCompileResourceInputs);
            $(ApplicationIcon);
            $(AssemblyOriginatorKeyFile);
            @(ReferencePath);
            @(CompiledLicenseFile);
            @(LinkResource);
            @(EmbeddedDocumentation);
            $(Win32Resource);
            $(Win32Manifest);
            @(CustomAdditionalCompileInputs)
        </InputFiles>

        <OutputFiles>
            @(DocFileItem);
            @(IntermediateAssembly);
            @(_DebugSymbolsIntermediatePath);
            $(NonExistentFile);
            @(CustomAdditionalCompileOutputs)
        </OutputFiles>
    </PropertyGroup>

    <Target Name="CheckCompileCacheBeforeCompile"
        Inputs="$(InputFiles)"
        Outputs="$(OutputFiles)">

        <CheckCompileCache
            Inputs="$(InputFiles)"
            Outputs="$(OutputFiles)" 
            ProjectName="$(ProjectName)">
            
            <Output TaskParameter="InputHash" PropertyName="InputHash"/>
        </CheckCompileCache>

    </Target>

    <Target Name="CacheArtifactsAfterCompile">
        <CacheArtifacts
            InputHash="$(InputHash)"
            Outputs="$(OutputFiles)" 
            ProjectName="$(ProjectName)" />
    </Target>
</Project>
